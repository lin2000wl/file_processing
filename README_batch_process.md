# 批量PDF处理工具使用说明

## 📋 功能概述

`batch_process_pdfs.sh` 是一个批量处理脚本，能够自动处理 `pdf/` 目录下的所有PDF文件，为每个文件生成：
- Markdown文件 (.md)
- 版面标注PDF (_layout.pdf)
- 中间结果JSON (_middle.json)
- 图片文件夹 (images/)
- **增强TXT文件** (.txt) - 去除#号，添加页面信息
- **页面截图文件夹** (page_images/) - 每页的完整截图

## ✨ 新增功能

### 🔧 智能文件重命名
脚本会在处理前自动重命名PDF文件，将以下字符替换为下划线：
- **空格**：`空格` → `_`
- **中文标点**：`，。！？；：""''（）【】《》` → `_`
- **英文标点**：`,.!?;:"(){}[]<>` → `_`
- **连字符**：`-` → `_`
- **多个连续下划线**：`___` → `_`
- **开头结尾下划线**：自动清理

**示例**：
- `GB 11554-2008 机动车和挂车用后雾灯配光性能.pdf` → `GB_11554_2008_机动车和挂车用后雾灯配光性能.pdf`
- `文档(2024年版).pdf` → `文档_2024年版_.pdf`

## 🚀 使用方法

### 1. 准备PDF文件
将要处理的PDF文件放入 `pdf/` 目录：
```bash
# 示例：将PDF文件复制到pdf目录
cp "your document.pdf" pdf/
cp "另一个文档(2024).pdf" pdf/
```

### 2. 运行批量处理
```bash
# 处理pdf目录下的所有PDF文件
./batch_process_pdfs.sh
```

脚本会自动执行以下步骤：
1. **文件重命名**：将特殊字符替换为下划线
2. **批量处理**：使用MonkeyOCR处理每个文件
3. **结果生成**：生成所有输出文件

### 3. 查看结果
处理完成后，结果将保存在 `output/` 目录中。

## 📁 输出结构

批量处理后，`output/` 目录结构如下：
```
output/
├── GB_11554_2008_机动车和挂车用后雾灯配光性能.md                    # Markdown文件
├── GB_11554_2008_机动车和挂车用后雾灯配光性能.txt                   # 增强TXT文件（新功能）
├── GB_11554_2008_机动车和挂车用后雾灯配光性能_layout.pdf            # 版面标注PDF
├── GB_11554_2008_机动车和挂车用后雾灯配光性能_middle.json           # 中间结果JSON
├── GB_11554_2008_机动车和挂车用后雾灯配光性能_images/               # 提取的图片
│   ├── image_1.png
│   └── image_2.png
├── GB_11554_2008_机动车和挂车用后雾灯配光性能_page_images/          # 页面截图（新功能）
│   ├── page_1.png
│   ├── page_2.png
│   └── page_3.png
├── 文档_2024年版_.md                    # 第二个文档的结果
├── 文档_2024年版_.txt
├── 文档_2024年版__layout.pdf
├── 文档_2024年版__middle.json
├── 文档_2024年版__images/
└── 文档_2024年版__page_images/
```

## 🔧 高级选项

### 自定义输出目录
如果需要自定义输出目录，可以修改脚本中的 `OUTPUT_DIR` 变量：
```bash
# 编辑脚本
nano batch_process_pdfs.sh

# 修改这一行：
OUTPUT_DIR="$SCRIPT_DIR/custom_output"
```

### 仅处理特定文件
如果只想处理特定的PDF文件，可以：
1. 将其他文件暂时移出 `pdf/` 目录
2. 或者使用单文件处理：
```bash
./run_enhanced.sh pdf/specific_file.pdf
```

### 跳过重命名
如果不希望重命名原文件，可以在脚本中注释掉重命名函数：
```bash
# 编辑脚本
nano batch_process_pdfs.sh

# 注释掉这一行：
# rename_files
```

## 📊 处理统计

脚本会显示详细的处理统计信息：
- 文件重命名操作结果
- 总文件数
- 成功处理的文件数
- 失败的文件数
- 失败文件的具体名称

## ⚠️ 注意事项

1. **虚拟环境要求**：脚本会自动激活虚拟环境，确保环境已正确设置
2. **GPU内存**：处理大量文件时注意GPU内存使用情况
3. **磁盘空间**：确保有足够的磁盘空间存储输出结果
4. **文件名变更**：原PDF文件会被重命名，请注意备份原文件名信息
5. **重复处理**：如果再次运行脚本，已重命名的文件不会再次重命名

## 🐛 故障排除

### 常见问题

1. **虚拟环境激活失败**
   ```bash
   # 检查虚拟环境路径
   ls -la file_processing_website/backend/venv/
   
   # 手动激活测试
   source file_processing_website/backend/venv/bin/activate
   ```

2. **PDF文件未找到**
   ```bash
   # 检查pdf目录
   ls -la pdf/
   
   # 确认文件扩展名为.pdf
   ```

3. **文件重命名失败**
   - 检查文件权限
   - 确认磁盘空间充足
   - 检查是否有其他程序占用文件

4. **处理失败**
   - 检查PDF文件是否损坏
   - 确认GPU内存是否充足
   - 查看错误日志

### 日志查看
脚本会实时显示处理过程，如需保存日志：
```bash
./batch_process_pdfs.sh 2>&1 | tee batch_process.log
```

## 📈 性能优化

1. **批量处理顺序**：脚本按文件名顺序处理
2. **内存管理**：每个文件处理完后会释放内存
3. **错误隔离**：单个文件失败不会影响其他文件的处理
4. **文件名优化**：自动重命名避免特殊字符导致的问题

## 🔗 相关文档

- [单文件处理说明](README_parse_enhanced.md)
- [整合方案总结](INTEGRATION_SUMMARY.md)
- [增强功能说明](README_enhancement.md)

## 💡 示例

```bash
# 1. 添加PDF文件（支持特殊字符文件名）
cp "GB 11554-2008 机动车和挂车用后雾灯配光性能.pdf" pdf/
cp "技术文档(最新版).pdf" pdf/

# 2. 运行批量处理
./batch_process_pdfs.sh

# 输出显示：
# 📝 开始重命名PDF文件...
# ✅ 重命名: GB 11554-2008 机动车和挂车用后雾灯配光性能.pdf → GB_11554_2008_机动车和挂车用后雾灯配光性能.pdf
# ✅ 重命名: 技术文档(最新版).pdf → 技术文档_最新版_.pdf

# 3. 查看结果
ls -la output/

# 4. 查看某个文件的TXT结果
cat "output/GB_11554_2008_机动车和挂车用后雾灯配光性能.txt"
```

## 🎯 批量处理优势

相比单个文件处理，批量处理具有以下优势：
- **一键处理**：无需逐个文件运行命令
- **智能重命名**：自动处理特殊字符文件名
- **统一管理**：所有结果集中在output目录
- **进度跟踪**：实时显示处理进度和统计
- **错误处理**：自动记录失败文件，便于后续处理
- **资源优化**：模型只加载一次，提高效率

## 📝 重命名规则详解

### 支持的字符替换
| 原字符类型 | 示例 | 替换后 |
|-----------|------|--------|
| 空格 | `文档 名称` | `文档_名称` |
| 中文标点 | `文档，名称。` | `文档_名称_` |
| 英文标点 | `doc,name.` | `doc_name_` |
| 括号 | `文档(2024)` | `文档_2024_` |
| 连字符 | `doc-name` | `doc_name` |
| 多个下划线 | `doc___name` | `doc_name` |

### 重命名安全性
- 重命名前会检查目标文件是否已存在
- 如果目标文件已存在，会跳过重命名
- 重命名失败不会影响后续处理
- 保持文件扩展名不变 